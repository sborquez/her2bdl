# Experiment information
experiment:
  # Custom indentifier name for the experiment.
  # Experiment
  name: SimpleClassifier-McDropout
  notes: SimpleClassifier with MC-Dropout for Her2 Classification using WSI-GridPatchGenerator.
  tags:
    - simple
    - her2
    - mcdropout
    - test
    - GridGenerator
  # Experiments folder: Contains multiples experiments
  experiments_folder: D:/sebas/Projects/her2bdl/train/experiments/runs
  #experiments_folder: /data/atlas/dbetalhc/cta-test/gerumo/src/her2bdl/train/experiments/runs
  # (Optional, default=null) numeric identfier for the experiment. If `null`, will be randomly picked.
  run_id: null
  # (Optional, default=null) Random seed, if it`s null, uses a random seed.
  seed: 1234

# Model architecture
model:
  # Model task: [classification|regression]
  task: classification
  # Model Class implemented in her2bdl.models
  architecture: SimpleClassifierMCDropout
  # (Optional, default=null) Models pretrained weights path. If it is null, use random weight initialization.
  weights: null
  # Model architecture hyperparameters
  hyperparameters: 
    mc_dropout_rate: 0.5
  # Model uncertainty hyperparameters
  uncertainty:
    sample_size: 200
    mc_dropout_batch_size: 8
    multual_information: true
    variation_ratio: true
    predictive_entropy: true

# Aggregation methods
aggregation: 
  # Method Class
  method: null
  # Mathod parameters
  parameters: null

# Datasets and preprocessing
data:
  # Source
  source:
    type: wsi
    # Source type parameters
    parameters:
      train_generator:
        generator: 'GridPatchGenerator'
        generator_parameters:
          #dataset: '/'
          dataset: 'D:/sebas/Projects/her2bdl/train/datasets/train.csv'
          patch_level: 5
          patch_vertical_flip: false
          patch_horizontal_flip: false
          shuffle: true
      validation_generator:
        generator: 'GridPatchGenerator'
        generator_parameters:
          dataset: 'D:/sebas/Projects/her2bdl/train/datasets/validation.csv'
          patch_level: 3
          patch_vertical_flip: false
          patch_horizontal_flip: false
          shuffle: true
      test_generator:
        generator: 'GridPatchGenerator'
        generator_parameters:
          dataset: 'D:/sebas/Projects/her2bdl/train/datasets/test.csv'
          patch_level: 3
          patch_vertical_flip: false
          patch_horizontal_flip: false
          shuffle: true
  # Input
  img_height: 80
  img_width: 80
  img_channels: 3
  preprocessing:
    rescale: null
    aggregate_dataset_parameters: null
  # Target
  num_classes: 4
  label_mode: categorical  # Depends on task and model architecture
  labels: 
    - '0'
    - '1+'
    - '2+'
    - '3+'

# Training model hyperparameters
training:
  # Training epochs
  epochs: 3
  # (Optional, default=16) Depends on CPU-GPU available memory.
  batch_size: 32
  # (Optional, default=0.2) Train and validation split.
  validation_split: null
  # Models loss function
  loss:
    function: CategoricalCrossentropy
    parameters: null
  # (Optional, default=Adam(lr=1e-4)) Training optimizer
  optimizer:
    name: adam
    learning_rate: 1e-5
    parameters: null
  # Training callbacks
  callbacks:
    # Connect to weight and bias *Requiere plugins and env variable.* 
    enable_wandb: true
    # Early stop, use null to disable. 
    earlystop: 
      patience: 15
      monitor: val_loss
    # Experiments results while training
    experiment_tracker:
      # Save model architecture summary
      log_model_summary: true
      # Save datasets info: source, sizes, etc. 
      log_dataset_description: true
      # Plots and logs
      log_training_loss: true
      log_predictions: true
      log_uncertainty: true
      log_metrics: true
      log_roc_curve: true
    # Save checkpoints: saved at experiments_folder/experiment/checkpoints
    checkpoints:
      # saved weights format
      format: "weights.{epoch:03d}-{val_loss:.4f}.h5"
      save_best_only: true
      save_weights_only: true
      monitor: val_loss
# Evaluation metrics
evaluate:
  metrics: [accuracy]
# Predict 
predict:
  save_aggregation: false
  save_predictions: true
  save_uncertainty: false
# Plugin setups
plugins:
  wandb:
    project: Her2BDL
    # Use environment variable name (recommended) or API KEY.
    apikey: WANDB_API_KEY