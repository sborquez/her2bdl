# Experiment information
experiment:
  # Custom indentifier name for the experiment.
  # Experiment
  name: HDXConvClassifier-McDropout08-C876-Base
  notes: HDXConvClassifier with MC-Dropout for Her2 Classification using WSI-MCPatchGenerator.
  tags:
    - hedconv
    - hdx
    - C876
    - dropout_rate=0.8
    - her2
    - MCPatchGenerator
    - baseline
    - evaluation
    - aggregation
  # Experiments folder: Contains multiples experiments
  #experiments_folder: D:/sebas/Projects/her2bdl/train/experiments/runs
  experiments_folder: /home/asuka/projects/her2bdl/train/experiments/runs
  #experiments_folder: /data/atlas/dbetalhc/cta-test/gerumo/src/her2bdl/train/experiments/runs
  # (Optional, default=null) numeric identfier for the experiment. If `null`, will be randomly picked.
  run_id: null
  # (Optional, default=null) Random seed, if it`s null, uses a random seed.
  seed: 1234

# Model architecture
model:
  # Model task: [classification|regression]
  task: classification
  # Model Class implemented in her2bdl.models
  architecture: HEDConvClassifierMCDropout
  # (Optional, default=null) Models pretrained weights path. If it is null, use random weight initialization.
  weights: /home/asuka/her2bdl-files/baseline/HDX-MCDropout08.h5
  aleatoric_weights: null
  # Model architecture hyperparameters
  hyperparameters: 
    ignore_eosin: true
    mc_dropout_rate: 0.8
    encoder_kernel_sizes:
      - 3
      - 3
      - 3
    conv_activation: swish
    classifier_dense_layers: 
      - 256
      - 128
      - 64
    dense_activation: swish
  # Model uncertainty hyperparameters
  uncertainty:
    sample_size: 200
    mc_dropout_batch_size: 200
    multual_information: true
    variation_ratio: true
    predictive_entropy: true

# Aggregation methods
aggregation: 
  # Method Class
  method: "ThresholdAggregator"
  # Mathod parameters
  parameters: 
    uncertainty_metric: "predictive_entropy"
    by : "CaseNo_label"
    threshold: 2

# Datasets and preprocessing
data:
  # Source
  source:
    type: wsi
    # Source type parameters
    parameters:
      train_generator:
        generator: 'MCPatchGenerator'
        generator_parameters:
          #dataset: 'D:/sebas/Projects/her2bdl/train/datasets/best_parameters/training.csv'
          dataset: '/home/asuka/projects/her2bdl/train/datasets/best_parameters/training.csv'
          #dataset: '/data/atlas/dbetalhc/cta-test/gerumo/src/her2bdl/train/datasets/best_parameters/training.csv'
          patch_level: 3
          samples_per_tissue: 200
          patch_vertical_flip: true
          patch_horizontal_flip: true
          shuffle: true
      validation_generator:
        generator: 'GridPatchGenerator'
        generator_parameters:
          #dataset: 'D:/sebas/Projects/her2bdl/train/datasets/best_parameters/training.csv'
          dataset: '/home/asuka/projects/her2bdl/train/datasets/best_parameters/validation.csv'
          #dataset: '/data/atlas/dbetalhc/cta-test/gerumo/src/her2bdl/train/datasets/best_parameters/training.csv'
          patch_level: 3
          patch_vertical_flip: false
          patch_horizontal_flip: false
          shuffle: true
      test_generator:
        generator: 'GridPatchGenerator'
        generator_parameters:
          #dataset: 'D:/sebas/Projects/her2bdl/train/datasets/test.csv'
          dataset: '/home/asuka/projects/her2bdl/train/datasets/test.csv'
          #dataset: '/data/atlas/dbetalhc/cta-test/gerumo/src/her2bdl/train/datasets/test.csv'
          patch_level: 3
          patch_vertical_flip: false
          patch_horizontal_flip: false
          shuffle: false
  # Input
  img_height: 240
  img_width: 240
  img_channels: 3
  preprocessing:
    rescale: null
    aggregate_dataset_parameters: null
  # Target
  num_classes: 4
  label_mode: categorical  # Depends on task and model architecture
  labels: 
    - '0'
    - '1+'
    - '2+'
    - '3+'

# Training model hyperparameters
training:
  # Training epochs
  epochs: 200
  # (Optional, default=16) Depends on CPU-GPU available memory.
  batch_size: 64
  # (Optional, default=0.2) Train and validation split.
  validation_split: null
  # Models loss function
  loss:
    function: CategoricalCrossentropy
    parameters: null
  # (Optional, default=sgd(lr=1e-4)) Training optimizer
  optimizer:
    learning_rate: 1e-4
    name: rmsprop
    parameters: 
       centered: True
  class_weight:
    - 1
    - 5
    - 5
    - 1
  # Training callbacks
  callbacks:
    # Connect to weight and bias *Requiere plugins and env variable.* 
    enable_wandb: true
    # Early stop, use null to disable. 
    earlystop: 
      patience: 50
      monitor: val_loss
    # Experiments results while training
    experiment_tracker:
      # Save model architecture summary
      log_predictions: true
      log_uncertainty: true
      log_confusion_matrix: true
      log_metrics: true
      log_roc_curve: true
    # Save checkpoints: saved at experiments_folder/experiment/checkpoints
    checkpoints:
      # saved weights format
      format: "weights.{epoch:03d}-{val_loss:.4f}.h5"
      save_best_only: true
      save_weights_only: true
      monitor: val_loss
# Evaluation metrics
evaluation:
  batch_size: 128
  evaluate_classification: false
  evaluate_aleatoric_uncertainty: false
  evaluate_aggregation: true
  experiment_logger:
    enable_wandb: true
    max_plots: 100
    classification_metrics:
      examples_n : 50
      log_predictions: false
      log_uncertainty: true
      top_n : 100
      log_uncertainty_highlights: true
      log_class_uncertainty: true
      log_confusion_matrix: true
      log_roc_curve: true
      log_metrics: true
    aleatoric_uncertainty:
      examples_n : 50
      log_uncertainty: true
      top_n : 100
      log_uncertainty_highlights: true
      log_class_uncertainty: true
    aggregation_metrics:
      examples_n : 50
      log_predictions: true
      log_map: true
      log_confusion_matrix: true
      log_class_uncertainty: true
      log_roc_curve: true
      log_metrics: true
      save_data: false
      save_predictions: true
      save_uncertainty: true
      save_aggregation: true
# Predict 
predict:
  save_data: false
  save_predictions: true
  save_uncertainty: true
  save_aggregation: true  
# Plugin setups
plugins:
  wandb:
    project: Her2BDL
    # Use environment variable name (recommended) or API KEY.
    #apikey: D:/sebas/Projects/her2bdl/.wandb_secret
    apikey: /home/asuka/projects/her2bdl/.wandb_secret
    #apikey: /data/atlas/dbetalhc/cta-test/gerumo/src/her2bdl/.wandb_secret